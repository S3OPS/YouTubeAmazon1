name: Secret Validation

on:
    schedule:
        # Validate secrets weekly on Wednesdays at 10 AM
        - cron: '0 10 * * 3'
    workflow_dispatch:
    pull_request:
        paths:
            - '.env.example'
            - 'server.js'
            - 'setup.js'

permissions:
    contents: read
    issues: write

jobs:
    validate-secrets:
        name: Validate Secret Configuration
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: '18'

            - name: Validate .env.example structure
              run: |
                  echo "üîç Validating .env.example structure..."
                  
                  # Check required variables exist
                  REQUIRED_VARS=(
                    "PRINTIFY_API_TOKEN"
                    "PRINTIFY_SHOP_ID"
                    "PRINTIFY_API_BASE_URL"
                    "PORT"
                    "NODE_ENV"
                  )
                  
                  MISSING=()
                  for var in "${REQUIRED_VARS[@]}"; do
                    if ! grep -q "^${var}=" .env.example; then
                      MISSING+=("$var")
                    fi
                  done
                  
                  if [ ${#MISSING[@]} -gt 0 ]; then
                    echo "‚ùå Missing required variables in .env.example:"
                    printf '%s\n' "${MISSING[@]}"
                    exit 1
                  else
                    echo "‚úÖ All required variables present in .env.example"
                  fi

            - name: Check for exposed secrets in code
              run: |
                  echo "üîç Scanning for exposed secrets..."
                  
                  # Patterns to search for
                  PATTERNS=(
                    "PRINTIFY_API_TOKEN.*=.*['\"][^'\"]{20,}"
                    "api[_-]?token.*=.*['\"][^'\"]{20,}"
                    "Bearer [a-zA-Z0-9_-]{20,}"
                    "shop[_-]?id.*=.*['\"][0-9]{5,}"
                  )
                  
                  FOUND=0
                  for pattern in "${PATTERNS[@]}"; do
                    if grep -rE "$pattern" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v ".env.example" | grep -v "test-"; then
                      echo "‚ö†Ô∏è  Found potential secret exposure"
                      FOUND=1
                    fi
                  done
                  
                  if [ $FOUND -eq 0 ]; then
                    echo "‚úÖ No exposed secrets found in code"
                  else
                    echo "‚ùå Potential secrets found in code!"
                    exit 1
                  fi

            - name: Validate server.js uses environment variables
              run: |
                  echo "üîç Validating server.js uses env vars..."
                  
                  # Check that server.js uses process.env
                  if grep -q "process\.env\.PRINTIFY_API_TOKEN" server.js; then
                    echo "‚úÖ server.js uses PRINTIFY_API_TOKEN from env"
                  else
                    echo "‚ùå server.js doesn't use PRINTIFY_API_TOKEN from env"
                    exit 1
                  fi
                  
                  if grep -q "process\.env\.PRINTIFY_SHOP_ID" server.js; then
                    echo "‚úÖ server.js uses PRINTIFY_SHOP_ID from env"
                  else
                    echo "‚ùå server.js doesn't use PRINTIFY_SHOP_ID from env"
                    exit 1
                  fi

            - name: Check .gitignore includes .env
              run: |
                  echo "üîç Checking .gitignore..."
                  
                  if grep -q "^\.env$" .gitignore; then
                    echo "‚úÖ .env is in .gitignore"
                  else
                    echo "‚ùå .env is NOT in .gitignore!"
                    exit 1
                  fi

            - name: Validate no .env file in repository
              run: |
                  echo "üîç Checking for .env file in repository..."
                  
                  if [ -f .env ]; then
                    echo "‚ùå .env file found in repository!"
                    echo "This should never be committed!"
                    exit 1
                  else
                    echo "‚úÖ No .env file in repository"
                  fi

            - name: Check for hardcoded URLs
              run: |
                  echo "üîç Checking for hardcoded API URLs..."
                  
                  # Look for hardcoded Printify URLs that should be in env
                  if grep -r "https://api.printify.com" --include="*.js" . | grep -v "\.env\.example" | grep -v "setup\.js" | grep -v "README" | grep -v "SETUP\.md"; then
                    echo "‚ö†Ô∏è  Found hardcoded Printify API URLs"
                    echo "These should use PRINTIFY_API_BASE_URL from env"
                    # Don't fail, just warn
                  else
                    echo "‚úÖ No hardcoded API URLs found"
                  fi

            - name: Create issue on validation failure
              if: failure()
              uses: actions/github-script@v8
              with:
                  script: |
                      const issue = await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'üîê Secret Validation Failed',
                        body: `## Secret Validation Failure
                        
                        The automated secret validation detected security issues.
                        
                        **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                        **Time:** ${new Date().toISOString()}
                        
                        **Possible Issues:**
                        - Missing required environment variables in .env.example
                        - Exposed secrets in code files
                        - Hardcoded credentials or tokens
                        - .env file committed to repository
                        - .env not in .gitignore
                        
                        Please review the workflow logs and fix the security issues immediately.`,
                        labels: ['automated', 'security', 'secrets', 'urgent']
                      });
                      console.log('Created issue:', issue.data.number);

            - name: Summary
              if: success()
              run: |
                  echo "## ‚úÖ Secret Validation Passed"
                  echo ""
                  echo "All secret configuration checks passed:"
                  echo "- ‚úÖ .env.example has all required variables"
                  echo "- ‚úÖ No secrets exposed in code"
                  echo "- ‚úÖ server.js uses environment variables"
                  echo "- ‚úÖ .env is in .gitignore"
                  echo "- ‚úÖ No .env file in repository"
