version: '3.8'

services:
    youtube-automation:
        build:
            context: .
            dockerfile: Dockerfile
        image: youtube-automation:latest
        container_name: youtube-automation
        ports:
            - '${PORT:-3000}:3000'
        environment:
            - NODE_ENV=${NODE_ENV:-development}
            - YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID}
            - YOUTUBE_CLIENT_SECRET=${YOUTUBE_CLIENT_SECRET}
            - YOUTUBE_REFRESH_TOKEN=${YOUTUBE_REFRESH_TOKEN}
            - AMAZON_AFFILIATE_TAG=${AMAZON_AFFILIATE_TAG}
            - AUTO_UPLOAD=${AUTO_UPLOAD:-false}
            - UPLOAD_SCHEDULE=${UPLOAD_SCHEDULE:-0 10 * * *}
            - PORT=3000
            - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
        env_file:
            - .env
        volumes:
            - ./videos:/app/videos
            - ./videos/processed:/app/videos/processed
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
                ]
            interval: 30s
            timeout: 3s
            retries: 3
            start_period: 5s
